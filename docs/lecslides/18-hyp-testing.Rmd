---
title: "Hypothesis testing"
author: "Prof Ellis"
date: "2021-11-05"
output:
  xaringan::moon_reader:
    css: "slides.css"
    logo: img/cogs137-logo-hex.png
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(broom)
library(knitr)
library(DT)
library(emo)
library(openintro)
library(infer)
```

```{r setup, include=FALSE}
# R options
options(
  htmltools.dir.version = FALSE, # for blogdown
  show.signif.stars = FALSE,     # for regression output
  warm = 1
  )
# Set dpi and height for images
opts_chunk$set(fig.height = 2.5, fig.width = 5, dpi = 300) 
# ggplot2 color palette with gray
color_palette <- list(gray = "#999999", 
                      salmon = "#E69F00", 
                      lightblue = "#56B4E9", 
                      green = "#009E73", 
                      yellow = "#F0E442", 
                      darkblue = "#0072B2", 
                      red = "#D55E00", 
                      purple = "#CC79A7")
htmltools::tagList(rmarkdown::html_dependency_font_awesome())
# For magick
dev.off <- function(){
  invisible(grDevices::dev.off())
}
# For ggplot2
ggplot2::theme_set(ggplot2::theme_bw())
```


## Announcements

- Tue OH moved to Tue 4-5:30pm
- Peer evals due Wed at 7pm -- must fill it out to receive your score
-

---

class: center, middle

# Hypothesis testing via simulation (for a single proportion)

---

## Packages

```{r message=FALSE}
library(tidyverse)
library(infer)
```


---

## Organ donors

People providing an organ for donation sometimes seek the help of a special "medical 
consultant". These consultants assist the patient in all aspects of the surgery, with 
the goal of reducing the possibility of complications during the medical procedure 
and recovery. Patients might choose a consultant based in part on the historical 
complication rate of the consultant's clients. 

One consultant tried to attract patients by noting that the average complication rate 
for liver donor surgeries in the US is about 10%, but her clients have only had 3 
complications in the 62 liver donor surgeries she has facilitated. She claims this is 
strong evidence that her work meaningfully contributes to reducing complications (and 
therefore she should be hired!).

---

## Data

```{r message=FALSE}
organ_donor <- read_csv("data/organ-donor.csv")
organ_donor %>%
  count(outcome)
```

---

## Parameter vs. statistic

A **parameter** for a hypothesis test is the "true" value of interest. We typically 
estimate the parameter using a **sample statistic** as a **point estimate**.

$p~$: true rate of complication

$\hat{p}~$: rate of complication in the sample = $\frac{3}{62}$ = 
`r round(3/62, 3)`

---

## Correlation vs. causation

.question[
`r emo::ji("bust_in_silhouette")` Is it possible to assess the consultant's claim using the data?
]

--

No. The claim is that there is a causal connection, but the data are observational.
For example, maybe patients who can afford a medical consultant can afford better
medical care, which can also lead to a lower complication rate.

While it is not possible to assess the causal claim, it is still possible to test 
for an association using these data. For this question we ask, could the low 
complication rate of $\hat{p}$ = `r round(3/62, 3)` be due to chance?

---

## Two claims

- **Null hypothesis:** "There is nothing going on"

Complication rate for this consultant is no different than the US average of 10%

--

- **Alternative hypothesis:** "There is something going on"

Complication rate for this consultant is **lower** than the US average of 10%

---

## Hypothesis testing as a court trial

- **Null hypothesis**, $H_0$: Defendant is innocent

- **Alternative hypothesis**, $H_A$: Defendant is guilty

--

- **Present the evidence:** Collect data

--

- **Judge the evidence:** "Could these data plausibly have happened by chance if the null hypothesis were true?"
    * Yes: Fail to reject $H_0$
    * No: Reject $H_0$
    
---

## Hypothesis testing framework

- Start with a null hypothesis, $H_0$, that represents the status quo

- Set an alternative hypothesis, $H_A$, that represents the research question, 
i.e. what weâ€™re testing for

- Conduct a hypothesis test under the assumption that the null hypothesis is true and 
calculate a **p-value** (probability of observed or more extreme outcome given that the 
null hypothesis is true)
    - if the test results suggest that the data do not provide convincing evidence for 
    the alternative hypothesis, stick with the null hypothesis
    - if they do, then reject the null hypothesis in favor of the alternative

---

## Setting the hypotheses

.question[
`r emo::ji("busts_in_silhouette")` Which of the following is the correct set of hypotheses?
]

(a) $H_0: p = 0.10$; $H_A: p \ne 0.10$ <br>

(b) $H_0: p = 0.10$; $H_A: p > 0.10$ <br>

(c) $H_0: p = 0.10$; $H_A: p < 0.10$ <br>

(d) $H_0: \hat{p} = 0.10$; $H_A: \hat{p} \ne 0.10$ <br>

(e) $H_0: \hat{p} = 0.10$; $H_A: \hat{p} > 0.10$ <br>

(f) $H_0: \hat{p} = 0.10$; $H_A: \hat{p} < 0.10$ <br>

---

## Simulating the null distribution

Since $H_0: p = 0.10$, we need to simulate a null distribution where the 
probability of success (complication) for each trial (patient) is 0.10.

.question[
`r emo::ji("busts_in_silhouette")` Describe how you would simulate the null distribution for this study using a bag of 
chips. How many chips? What colors? What do the colors indicate? How many draws? 
<b>With replacement</b> or <b>without replacement</b>?
]

---

## What do we expect?

.question[
`r emo::ji("bust_in_silhouette")` When sampling from the null distribution, what is the expected proportion of success 
(complications)?
]

---

## Simulation #1

```{r echo=FALSE, message=FALSE, warning=FALSE}
# set seed
set.seed(20171011)

# create sample space
outcomes <- c("complication", "no complication")

# draw the first sample of size 62 from the null distribution
sim1 <- sample(outcomes, size = 62, prob = c(0.1, 0.9), replace = TRUE)

# view the sample
table(sim1)

# calculate the simulated sample proportion of complications (red chips)
(p_hat_sim1 <- sum(sim1 == "complication") / length(sim1))

# create an empty data frame
sim_dist <- data.frame(p_hat_sim = rep(NA, 3))

# record the simulated p-hat as the first observation
sim_dist$p_hat_sim[1] <- p_hat_sim1

# plot
ggplot(sim_dist, aes(x = p_hat_sim)) + 
  geom_dotplot() + 
  xlim(0, 0.26) + ylim(0, 10)
```

---

## Simulation #2

```{r message=FALSE, warning=FALSE, echo=FALSE}
sim2 <- sample(outcomes, size = 62, prob = c(0.1, 0.9), replace = TRUE)

table(sim2)

(p_hat_sim2 <- sum(sim2 == "complication") / length(sim2))

sim_dist$p_hat_sim[2] <- p_hat_sim2

ggplot(sim_dist, aes(x = p_hat_sim)) + 
  geom_dotplot() + 
  xlim(0,0.26) + ylim(0,10)
```

---

## Simulation #3


```{r message=FALSE, warning=FALSE, echo=FALSE}
sim3 <- sample(outcomes, size = 62, prob = c(0.1, 0.9), replace = TRUE)

table(sim3)

(p_hat_sim3 <- sum(sim3 == "complication") / length(sim3))

sim_dist$p_hat_sim[3] <- p_hat_sim3

ggplot(sim_dist, aes(x = p_hat_sim)) + 
  geom_dotplot() + 
  xlim(0,0.26) + ylim(0,10)
```

---

## This is getting boring...

We need a way to automate this process!

---

## Using `infer` to generate the null distribution

.small[
```{r}
null_dist <- organ_donor %>%
  specify(response = outcome, success = "complication") %>%
  hypothesize(null = "point", p = c("complication" = 0.10, "no complication" = 0.90)) %>% 
  generate(reps = 100, type = "simulate") %>% 
  calculate(stat = "prop")
```
]

```{r echo=FALSE}
null_dist %>% 
  mutate(
    replicate = as.numeric(replicate),
    stat = round(stat, 3)
    )
```


---

## Visualizing the null distribution

.question[
`r emo::ji("bust_in_silhouette")` What would you expect the center of the null distribution to be?
]

--

```{r}
ggplot(data = null_dist, mapping = aes(x = stat)) +
  geom_histogram(binwidth = 0.01) +
  labs(title = "Null distribution")
```


---

## Calculating the p-value, visually

.question[
`r emo::ji("busts_in_silhouette")` What is the p-value, i.e. in what % of the 
simulations was the simulated sample proportion at least as extreme as the 
observed sample proportion?
]

```{r echo=FALSE}
ggplot(data = null_dist, mapping = aes(x = stat)) +
  geom_histogram(binwidth = 0.01) +
  labs(title = "Null distribution")
```

---

## Calculating the p-value, directly

```{r}
null_dist %>%
  filter(stat <= (3/62)) %>%
  summarise(p_value = n()/nrow(null_dist))
```


---

## Significance level

We often use 5% as the cutoff for whether the p-value is low enough that the data are 
unlikely to have come from the null model. This cutoff value is called the 
**significance level**, $\alpha$.

- If p-value < $\alpha$, reject $H_0$ in favor of $H_A$: The data provide convincing 
evidence for the alternative hypothesis.

- If p-value > $\alpha$, fail to reject $H_0$ in favor of $H_A$: The data do not provide 
convincing evidence for the alternative hypothesis.

---

## Conclusion

.question[
`r emo::ji("bust_in_silhouette")` What is the conclusion of the hypothesis test?
]

--

Since the p-value is greater than the significance level, we fail to 
reject the null hypothesis. These data do not provide convincing evidence that this 
consultant incurs a lower complication rate than 10% (overall US complication rate).

---

## Let's get real

- 100 simulations is not sufficient

- We usually simulate around 15,000 times to get an accurate distribution

---

## Run the test

.small[
```{r cache=TRUE}
null_dist <- organ_donor %>%
  specify(response = outcome, success = "complication") %>%
  hypothesize(null = "point", p = c("complication" = 0.10, "no complication" = 0.90)) %>% 
  generate(reps = 15000, type = "simulate") %>% 
  calculate(stat = "prop", order = c("treatment", "control"))
```
]

---

## Visualize and calculate

.small[
```{r fig.height=1.5}
ggplot(data = null_dist, mapping = aes(x = stat)) +
  geom_histogram(binwidth = 0.01) +
  geom_vline(xintercept = 3/62, color = "red")

null_dist %>%
  filter(stat <= 3/62) %>%
  summarise(p_value = n()/nrow(null_dist))
```
]

---

class: center, middle

# One vs. two sided hypothesis tests

---

## Types of alternative hypotheses

- One sided (one tailed) alternatives: The parameter is hypothesized to be less 
than or greater than the null value, < or >

--

- Two sided (two tailed) alternatives: The parameter is hypothesized to be not 
equal to the null value, $\ne$
    - Calculated as two times the tail area beyond the observed sample statistic
    - More objective, and hence more widely preferred
    
--

.question[
`r emo::ji("bust_in_silhouette")` Average systolic blood pressure of people with 
Stage 1 Hypertension is 150 mm Hg. Suppose we want to use a hypothesis test to 
evaluate whether a new blood pressure medication has <b>an effect</b> on the average 
blood pressure of heart patients. What are the hypotheses?
]

---

class: center, middle

# Testing for independence

---

## Is yawning contagious?

.question[
`r emo::ji("bust_in_silhouette")` Do you think yawning is contagious?
]

.pull-left[
![empirical](img/09a/yawn1.png)
]
.pull-right[
![empirical](img/09a/yawn2.png)
]

---

## Is yawning contagious?

An experiment conducted by the MythBusters tested if a person can be subconsciously influenced into yawning if another person near them yawns.

https://www.youtube.com/watch?v=mrr_UjNLbhE

---

## Study description

In this study 50 people were randomly assigned to two groups: 34 to a group where a person near them yawned (treatment) and 16 to a control group where they didn't see someone yawn (control).

```{r message=FALSE}
mb_yawn <- read_csv("data/mb-yawn.csv")
```

```{r}
mb_yawn %>%
  count(group, outcome)
```

---

## Proportion of yawners

.small[
```{r}
mb_yawn %>%
  count(group, outcome) %>%
  group_by(group) %>%
  mutate(p_hat = n / sum(n))
```
]

- Proportion of yawners in the treatment group: $\frac{10}{34} = 0.2941$
- Proportion of yawners in the control group: $\frac{4}{16} = 0.25$
- Difference: $0.2941 - 0.25 = 0.0441$
- Our results match the ones calculated on the MythBusters episode.

---

## Independence?

.question[
`r emo::ji("bust_in_silhouette")` Based on the proportions we calculated, 
do you think yawning is really contagious, i.e. are seeing someone yawn 
and yawning dependent?
]

```{r echo=FALSE}
mb_yawn %>%
  count(group, outcome) %>%
  group_by(group) %>%
  mutate(p_hat = n / sum(n))
```

---

## Dependence, or another possible explanation?

- The observed differences might suggest that yawning is contagious, i.e. seeing someone yawn 
and yawning are dependent.

- But the differences are small enough that we might wonder if they might simple be **due to chance**.

- Perhaps if we were to repeat the experiment, we would see slightly different results.

- So we will do just that - well, somewhat - and see what happens.

- Instead of actually conducting the experiment many times, we will **simulate** our results.

---

## Two competing claims

- "There is nothing going on." 
Yawning and seeing someone yawn are **independent**, yawning is not contagious, observed difference in proportions is simply due to chance. $\rightarrow$ Null hypothesis

- "There is something going on."
Yawning and seeing someone yawn are **dependent**, yawning is contagious, observed difference in proportions is not due to chance. $\rightarrow$ Alternative hypothesis

---

## Simulation setup

1. A regular deck of cards is comprised of 52 cards: 4 aces, 4 of numbers 2-10, 4 jacks, 4 queens, and 4 kings.

2. Take out two aces from the deck of cards and set them aside.

3. The remaining 50 playing cards to represent each participant in the study:
    - 14 face cards (including the 2 aces) represent the people who yawn.
    - 36 non-face cards represent the people who don't yawn.

---

## Running the simulation

1. Shuffle the 50 cards at least 7 times<sup>1</sup> to ensure that the cards counted out are from a random process.

2. Count out the top 16 cards and set them aside. These cards represent the people in the control group.

3. Out of the remaining 34 cards (treatment group) count the \red{number of face cards} (the number of people who yawned in the treatment group).

4. Calculate the difference in proportions of yawners (treatment - control), and plot it 
on the board.

5. Mark the difference you find on the dot plot on the board.

.footnote[
[1] http://www.dartmouth.edu/~chance/course/topics/winning_number.html
]

---

## Checking for independence

.question[
`r emo::ji("busts_in_silhouette")` Do the simulation results suggest that yawning 
is contagious, i.e. does seeing someone yawn and yawning appear to be dependent?
]

.small[
```{r}
null_dist <- mb_yawn %>%
  specify(outcome ~ group, success = "yawn") %>%
  hypothesize(null = "independence") %>%
  generate(100, type = "permute") %>%
  calculate(stat = "diff in props", order = c("treatment", "control"))
```
]

---

## Visualizing the null distribution

.question[
`r emo::ji("bust_in_silhouette")` What would you expect the center of the 
null distribution to be?
]

--

```{r}
ggplot(data = null_dist, mapping = aes(x = stat)) +
  geom_histogram(binwidth = 0.05) +
  labs(title = "Null distribution")
```

---

## Calculating the p-value, visually

.question[
`r emo::ji("busts_in_silhouette")` What is the p-value, i.e. in what % of the 
simulations was the simulated difference in sample proportion at least as extreme 
as the observed difference in sample proportions?
]

```{r echo=FALSE}
ggplot(data = null_dist, mapping = aes(x = stat)) +
  geom_histogram(binwidth = 0.05) +
  labs(title = "Null distribution")
```

---

## Calculating the p-value, directly

```{r}
null_dist %>%
  filter(stat >= 0.0441) %>%
  summarise(p_value = n()/nrow(null_dist))
```

---

## Conclusion

.question[
`r emo::ji("busts_in_silhouette")` What is the conclusion of the hypothesis test?
]

<br>

--

.question[
`r emo::ji("bust_in_silhouette")` Do you "buy" this conclusion?
]

## Recap: visualize and describe

.question[
When asked to visualize and describe distribution(s), how do you decide what visualizations to make?
]

--

- Make all possible visualizations for the relevant variables, e.g. 
    - for a single numerical variable, try a histogram as well as a box plot and a density plot.
    - for one numerical and one categorical variable, try density plots, violin plots, faceted histograms, and side-by-side box plots.

- This doesn't mean include **all** of these in your final write up. Try them out, see which one(s) help tell a story, and include that/those only in your write up. But you won't know without trying which one(s) to include.

---

## Recap: visualize and describe

.question[
When asked to visualize and describe distribution(s), how do you decide what to mention in your description?
]

--

- Shape, center, spread, and any unusual observations.

Simply stating features isn't sufficient, dig deeper to see why these features are apparent, e.g.

- if the distribution is bimodal, determine where the peaks are and try to figure out why these show up as two prominent peaks (are there two prominent groups in your data, what are they?)

- if there are outliers, and the observations are identifiable, identify the outliers and try to figure out why these observations stand out as outliers (the answer might be in the data, or might req)

---

## HW 3: Season and bike rentals

Prompt: Create a visualization displaying the relationship between bike rentals and season. Interpret the plot in context of the data.

---

## Option 1

```{r load-data, message=FALSE, echo=FALSE}
bike <- read_csv("data/bikeshare-day.csv") %>%
  mutate(
    season = case_when(
      season == 1 ~ "winter",
      season == 2 ~ "spring",
      season == 3 ~ "summer",
      season == 4 ~ "fall"
    ),
    season = fct_relevel(season, "spring", "summer", "fall", "winter"),
    temp_raw = temp * 41,
    atemp_raw = atemp * 50,
    hum_raw = hum * 100,
    windspeed_raw = windspeed * 67,
      weathersit = case_when(
      weathersit == 1 ~ "clear",
      weathersit == 2 ~ "mist",
      weathersit == 3 ~ "light precipitation"
      # no 4s in the data
    ),
    weathersit = fct_relevel(weathersit, "clear", "mist", "light precipitation")
    # also ok if they made winter baseline
  )
```

```{r bike-hist-facet}
ggplot(data = bike, aes(x = cnt)) +
  geom_histogram(binwidth = 1000) +
  facet_grid(. ~ season)
```

---

## Option 2

```{r bike-dens}
ggplot(data = bike, aes(x = cnt, color = season, fill = season)) +
  geom_density(alpha = 0.5)
```

---

## Option 3

Daily bike rentals are highest on a typical summer day and lowest on a typical winter day. The variablity of daily bike rentals are somewhat consistent across seasons, but lowest in the summer. There is a high outlier in the winter, and low outlier in the fall.

```{r bike-box}
ggplot(data = bike, aes(x = season, y = cnt)) +
  geom_boxplot()
```

---

## Ok, but not satisfying

- The observations in this dataset are recognizable days.

- First, drill down and identify what they sre.

- Then, try to figure out why these observations stand out as outliers.

- It's possible you won't be able to, but you should try.

---

## High outlier in the winter

```{r}
bike %>%
  filter(season == "winter") %>%
  summarise(min = max(cnt), day_min = dteday[which.max(cnt)])
```

--

.question[
What happened on March 17, 2012 in Washington DC? If you don't know, google it!
]

---

![March 17, 2012](img/10a/dc-03-17-2012.png)
---

## Low outlier in the fall

```{r}
bike %>%
  filter(season == "fall") %>%
  summarise(min = min(cnt), day_min = dteday[which.min(cnt)])
```

--

.question[
What happened on October 29, 2012 in Washington DC? If you don't know, google it!
]

---

![October 10, 2012](img/10a/dc-10-29-2012.png)

---

## Details matter

.question[
Which of the following is a more informative analysis?

(a) There is a high outlier in the winter, and low outlier in the fall.

(b) There is a low outlier in the winter, on St. Patrick's Day. And a low outlier in the fall, on the day Hurricane Sandy hit DC. 
]

---

## Interpreting regression coefficients

--

- For a model with a single predictor: "For each unit increase in $x$, $y$ is expected to be higher/lower by $b_1$, on average."

--

- For a model with a multiple predictors: "**All else held constant**,for each unit increase in $x_1$, $y$ is expected to be higher/lower by $b_1$, on average."

--

    - "All else" = all other variables **in** the model.

---

## 

.question[
Interpret the coefficient of holiday.
]

```{r m_full, echo=FALSE}
m_full <- lm(cnt ~ season + yr + holiday + workingday + weathersit + temp_raw + 
                   atemp_raw + hum_raw + windspeed_raw + atemp_raw * holiday, 
                   data = bike)
m_full %>%
  tidy() %>%
  select(term, estimate) %>%
  mutate(estimate = round(estimate, 3))
```

--

All else held constant, daily bike rentals are expected to be lower on holidays by 1384, on average, compared to non-holiday days.

---

## 

.question[
Discuss what makes for a good day to bike in DC.
]

```{r echo=FALSE}
m_full %>%
  tidy() %>%
  select(term, estimate) %>%
  mutate(estimate = round(estimate, 3))
```

--

With everything else being the same, Fall days are more popular for bike rentals than days in any other season. Alternatively, with everything else being constant, days with lower humidity are better for biking than days with higher humidity.

---

class: center, middle

# Simulation based inference review

---

## What do you want to do?

- Estimation -> Confidence interval

- Decision -> Hypothesis test

- First step: Ask the following questions

  1. How many variables?
  2. What type(s) of variable(s)?
  3. What is the research question?

---

## Data: NC births

The dataset is in the `openintro` package.

```{r}
glimpse(ncbirths)
```

---

## Length of gestation

```{r echo=FALSE, warning=FALSE}
ggplot(data = ncbirths, aes(x = weeks)) +
  geom_histogram(binwidth = 1)
```

```{r echo=FALSE}
ncbirths %>%
  filter(!is.na(weeks)) %>%
  summarise(
    min = min(weeks),
    xbar = round(mean(weeks), 2),
    med = median(weeks),
    s = round(sd(weeks), 2),
    q1 = quantile(weeks, 0.25),
    q3 = quantile(weeks, 0.75),
    max = max(weeks)
  )
```


---

## Length of gestation

.question[
Assuming that this sample is representative of all births in NC, we are 95% confident that the average length of gestation for babies in NC is between ---- and ---- weeks.
]

--

**(1) How many variables?**

--

1 variable: length of gestation, `weeks`

--

**(2) What type(s) of variable(s)?**

--

Numerical

--

**(3) What is the research question?**

--

Estimate the average length of gestation $\rightarrow$ confidence interval

---

## Simulation for CI for a mean

**Goal:** Use bootstrapping to estimate the sampling variability of the mean, i.e. the variability of means taken from the same population with the same sample size.

--

1. Take a bootstrap sample - a random sample taken with replacement from the 
original sample, of the same size as the original sample.

2. Calculate the mean of the bootstrap sample.

3. Repeat steps (1) and (2) many times to create a bootstrap distribution - 
a distribution of bootstrap means.

4. Calculate the bounds of the 95% confidence interval as the middle 95% 
of the bootstrap distribution.

---

## Set a seed first

From the documentation of `set.seed`:

- `set.seed` uses a single integer argument to set as many seeds as are required. There is no guarantee that different values of seed will seed the RNG differently, although any exceptions would be extremely rare.

- Initially, there is no seed; a new one is created from the current time and the process ID when one is required. Hence different sessions will give different simulation results, by default.

```{r}
set.seed(20180326)
```

---

## Computation for CI for a mean

```{r}
boot_means <- ncbirths %>%
  filter(!is.na(weeks)) %>% # remove NAs
  specify(response = weeks) %>%
  generate(reps = 1000, type = "bootstrap") %>%
  calculate(stat = "mean")
ggplot(data = boot_means, aes(x = stat)) +
  geom_histogram(binwidth = 0.03)
```

---

## Length of gestation

```{r}
boot_means %>%
  summarise(
    lower = quantile(stat, 0.025),
    upper = quantile(stat, 0.975)
  )
```

--

Assuming that this sample is representative of all births in NC, we are 95% confident that the average length of gestation for babies in NC is between 38.1 and 38.5 weeks.

---

## Length of gestation, revisited

.question[
The average length of human gestation is 280 days, or 40 weeks, from the first day of the woman's last menstrual period. Do these data provide convincing evidence that average length of gestation for women in NC is different than 40 weeks? Use a significance level of 5%.
]

--

$H_0: \mu = 40$  
$H_A: \mu \ne 40$

--

- We just said, "we are 95% confident that the average length of gestation for babies in NC is between 38.1 and 38.5 weeks".

- Since the null value is outside the CI, we would reject the null hypothesis in favor of the alternative.

- But an alternative, more direct, way of answering this question is using a hypothesis test.

---

## Simulation for HT for a mean

**Goal:** Use bootstrapping to generate a sampling distribution under the assumption of the null hypothesis being true. Then, calculate the p-value to make a decision on the hypotheses.

--

1. Take a bootstrap sample - a random sample taken with replacement from the 
original sample, of the same size as the original sample.

2. Calculate the mean of the bootstrap sample.

3. Repeat steps (1) and (2) many times to create a bootstrap distribution - 
a distribution of bootstrap means.

4. Shift the bootstrap distribution to be centered at the null value by subtracting/adding the difference between the center of the bootstrap distribution and the null value to each bootstrap mean.

5. Calculate the p-value as the proportion of simulations that yield a sample mean at least as extreme as the observed sample mean.

---

## Computation for HT for a mean

```{r fig.height=2}
boot_means_shifted <- ncbirths %>%
  filter(!is.na(weeks)) %>% # remove NAs
  specify(response = weeks) %>%
  hypothesize(null = "point", mu = 40) %>% # hypothesize step
  generate(reps = 1000, type = "bootstrap") %>%
  calculate(stat = "mean")
ggplot(data = boot_means_shifted, aes(x = stat)) +
  geom_histogram(binwidth = 0.03) +
  geom_vline(xintercept = 38.33, color = "red") +
  geom_vline(xintercept = 40 + (40 - 38.33), color = "red")
```

---

## Length of gestation

```{r}
boot_means_shifted %>%
  filter(stat <= 38.33) %>%
  summarise(p_value = 2 * (n() / 1000))
```

--

Since p-value less than the significance level, we reject the null hypothesis. The data provide convincing evidence that the average length of gestation of births in NC is different than 40.

---

## Exercises

Go to RStudio Cloud, make a copy of **NC Births**, and answer the following questions.

1. Do these data provide convincing evidence of a difference in length in gestation between mature and younger moms? Use a significance level of 10%.

2. Estimate the difference in average lengths of gestation between mature and younger moms. Use a significance level equivalent to the hypothesis test above.

3. Do the results of the hypothesis test agree with the result of the confidence interval?

---

## `infer` structure

```{r eval=FALSE}
df %>%
  specify(response, explanatory) %>% # explanatory optional
  generate(reps, type) %>% # type: bootstrap, simulate, or permute
  calculate(stat)
```

- Always start with data frame
- Result is always a data frame with a variable called `stat`
   - See the documentation for `calculate` to see which `stat`istics can be calculated
- For hypothesis testing add a `hypothesize()` step between `specify()` and `generate()`
    - `null = "point"`, and then specify the null value
    - `null = "independence"`
    
    ---

# From last time - Testing for independence

---

## Study results

```{r message=FALSE}
mb_yawn <- read_csv("data/mb-yawn.csv")
```

.small[
```{r}
mb_yawn %>%
  count(group, outcome) %>%
  group_by(group) %>%
  mutate(p_hat = n / sum(n))
```
]

Difference in proportions of yawners: 

$\hat{p}_{treatment} - \hat{p}_{control} = 0.2941 - 0.25 = 0.0441$

---

## Two competing claims

- "There is nothing going on." 
Yawning and seeing someone yawn are **independent**, yawning is not contagious, observed difference in proportions is simply due to chance. $\rightarrow$ Null hypothesis

- "There is something going on."
Yawning and seeing someone yawn are **dependent**, yawning is contagious, observed difference in proportions is not due to chance. $\rightarrow$ Alternative hypothesis

---

## Running the simulation

1. Shuffle the 50 cards at least 7 times<sup>1</sup> to ensure that the cards counted out are from a random process.

2. Count out the top 16 cards and set them aside. These cards represent the people in the control group.

3. Out of the remaining 34 cards (treatment group) count the \red{number of face cards} (the number of people who yawned in the treatment group).

4. Calculate the difference in proportions of yawners (treatment - control), and plot it 
on the board.

5. Mark the difference you find on the dot plot on the board.

.footnote[
[1] http://www.dartmouth.edu/~chance/course/topics/winning_number.html
]

---

## Simulation by hand

.question[
`r emo::ji("busts_in_silhouette")` Do the simulation results suggest that yawning 
is contagious, i.e. does seeing someone yawn and yawning appear to be dependent?
]

![yawn-sim-results](img/09b/yawn-sim-results.png)

---

## Simulation by computation

```{r}
null_dist <- mb_yawn %>%
  specify(response = outcome, explanatory = group, 
          success = "yawn") %>%
  hypothesize(null = "independence") %>%
  generate(100, type = "permute") %>%
  calculate(stat = "diff in props", 
            order = c("treatment", "control"))
```

---

## Simulation by computation - 1

.small[
- Start with the data frame
- **Specify the variables**
    - **Since the response variable is categorical, specify the level which should be considered as "success"**

```{r eval=FALSE}
mb_yawn %>%
{{  specify(response = outcome, explanatory = group, 
          success = "yawn") }}
```
]

---

## Simulation by computation - 2

.small[
- Start with the data frame
- Specify the variables
    - Since the response variable is categorical, specify the level which should be considered as "success"
- **State the null hypothesis (yawning and whether or not you see someone yawn are independent)**

```{r eval=FALSE}
mb_yawn %>%
  specify(response = outcome, explanatory = group, 
          success = "yawn") %>%
{{ hypothesize(null = "independence") }}
```
]

---

## Simulation by computation - 3

.small[
- Start with the data frame
- Specify the variables
    - Since the response variable is categorical, specify the level which should be considered as "success"
- State the null hypothesis (yawning and whether or not you see someone yawn are independent)
- **Generate simulated differences via permutation**

```{r eval=FALSE}
mb_yawn %>%
  specify(response = outcome, explanatory = group, 
          success = "yawn") %>%
  hypothesize(null = "independence") %>%
{{ generate(100, type = "permute") }}
```
]

---

## Simulation by computation - 4

.small[
- Start with the data frame
- Specify the variables
    - Since the response variable is categorical, specify the level which should be considered as "success"
- State the null hypothesis (yawning and whether or not you see someone yawn are independent)
- Generate simulated differences via permutation
- **Calculate the sample statistic of interest (difference in propotions)**
    - **Since the explanatory variable is categorical, specify the order in which the subtraction should occur for the calculation of the sample statistic, $(\hat{p}_{treatment} - \hat{p}_{control})$.**
    
```{r eval=FALSE}
mb_yawn %>%
  specify(response = outcome, explanatory = group, 
          success = "yawn") %>%
  hypothesize(null = "independence") %>%
  generate(100, type = "permute") %>%
{{ calculate(stat = "diff in props", 
           order = c("treatment", "control")) }}
```
]

---

## Simulation by computation - 0

.small[
- **Save the result**
- Start with the data frame
- Specify the variables
    - Since the response variable is categorical, specify the level which should be considered as "success"
- State the null hypothesis (yawning and whether or not you see someone yawn are independent)
- Generate simulated differences via permutation
- Calculate the sample statistic of interest (difference in propotions)
    - Since the explanatory variable is categorical, specify the order in which the subtraction should occur for the calculation of the sample statistic, $(\hat{p}_{treatment} - \hat{p}_{control})$.
    
```{r eval=FALSE}
{{null_dist <- mb_yawn %>% }}
  specify(response = outcome, explanatory = group, 
          success = "yawn") %>%
  hypothesize(null = "independence") %>%
  generate(100, type = "permute") %>%
  calculate(stat = "diff in props", 
            order = c("treatment", "control"))
```
]

---

## Visualizing the null distribution

.question[
`r emo::ji("bust_in_silhouette")` What would you expect the center of the 
null distribution to be?
]

--

```{r}
ggplot(data = null_dist, mapping = aes(x = stat)) +
  geom_histogram(binwidth = 0.05) +
  labs(title = "Null distribution")
```

---

## Calculating the p-value, visually

.question[
`r emo::ji("busts_in_silhouette")` What is the p-value, i.e. in what % of the 
simulations was the simulated difference in sample proportion at least as extreme 
as the observed difference in sample proportions?
]

```{r echo=FALSE}
ggplot(data = null_dist, mapping = aes(x = stat)) +
  geom_histogram(binwidth = 0.05) +
  labs(title = "Null distribution")
```

---

## Calculating the p-value, directly

```{r}
null_dist %>%
  filter(stat >= 0.0441) %>%
  summarise(p_value = n()/nrow(null_dist))
```

---

## Conclusion

.question[
`r emo::ji("busts_in_silhouette")` What is the conclusion of the hypothesis test?
]

<br>

--

.question[
`r emo::ji("bust_in_silhouette")` Do you "buy" this conclusion?
]

---

class: center, middle

# Inference overview

---

## What do you want to do?

- Estimation -> Confidence interval

- Decision -> Hypothesis test

- First step: Ask the following questions

  1. How many variables?
  2. What types of variables?
  3. What is the research question?

---

class: center, middle

# Confidence intervals

---

## Confidence intervals

- Bootstrap

- Bounds: cutoff values for the middle XX% of the distribution

- Interpretation: We are XX% confident that the true population parameter is in the interval.

- Definition of confidence level: XX% of random samples of size n are expected to produce confidence intervals that contain the true population parameter.

- `infer::generate(reps, type = "bootstrap")`

---

## Confidence intervals exercises

.small[
.question[
`r emo::ji("busts_in_silhouette")` Describe the simulation process for estimating the parameter assigned to your team.

- Note any assumptions you make in terms of sample size, observed sample statistic, etc.
- Imagine using index cards or chips to represent the data. 
- Specify whether the simulation type would be bootstrap, simulate, or permute.

> **Panda Express, BME, get MECT, Duke Squirrels, Team Power:** single population median

> **ACE, Kimchi Stew, Databaes, HJC, 23, 24/7, five squared:** single population proportion

> **Team Untitled, R we done yet?, Blue Wombats, Cosmic:** difference between two population means

> **InterstellR, Tequila Mockingbird, Sweeter than SugR:** difference between two population proportions

> **The Data Wranglers, Git R Done, Migos, Six Squared:** single population standard deviation
]]

---

## Accuracy vs. precision

.question[
`r emo::ji("busts_in_silhouette")` What happens to the width of the confidence interval as the confidence level increases? Why? Should we always prefer a confidence interval with a higher confidence level?
]

---

## Sample size and width of intervals

```{r echo = FALSE, warning=FALSE, message=FALSE, fig.width=10, fig.height=7}
set.seed(20171107)
acs_emp <- acs12 %>% filter(employment == "employed", income > 0)
acs_10 <- acs_emp %>% sample_n(10) %>%
  specify(response = income) %>%
  generate(1000, type = "bootstrap") %>%
  calculate(stat = "median")
acs_100 <- acs_emp %>% sample_n(100) %>%
  specify(response = income) %>%
  generate(1000, type = "bootstrap") %>%
  calculate(stat = "median")
acs_500 <- acs_emp %>% sample_n(500) %>%
  specify(response = income) %>%
  generate(1000, type = "bootstrap") %>%
  calculate(stat = "median")
p1 <- ggplot(acs_10, aes(x = stat)) + geom_histogram(binwidth = 5000) + xlim(0, 120000) + ggtitle("Sample size = 10")
p2 <- ggplot(acs_100, aes(x = stat)) + geom_histogram(binwidth = 5000) + xlim(0, 120000) + ggtitle("Sample size = 100")
p3 <- ggplot(acs_500, aes(x = stat)) + geom_histogram(binwidth = 5000) + xlim(0, 120000) + ggtitle("Sample size = 500")
gridExtra::grid.arrange(p1, p2, p3, ncol = 1)
```


---

## Equivalency of confidence and significance levels

- Two sided alternative HT with $\alpha$ $\rightarrow$ $CL = 1 - \alpha$
- One sided alternative HT with $\alpha$ $\rightarrow$ $CL = 1 - (2 \times \alpha)$

```{r echo = FALSE, message=FALSE, fig.width=10, fig.height=4}
par(mfrow = c(1,2))
normTail(U = 1.96, L = -1.96, df = 100, col = "#56B4E9", axes = FALSE)
text(x = 0, y = 0.15, "0.95", col = "#56B4E9", cex = 2)
text(x = -3, y = 0.05, "0.025", col = "#56B4E9", cex = 1.5)
text(x = 3, y = 0.05, "0.025", col = "#56B4E9", cex = 1.5)
#
normTail(U = 1.65, L = -1.65, df = 100, col = "#56B4E9", axes = FALSE)
normTail(U = 1.65, df = 100, col = "gray", add = TRUE, axes = FALSE)
text(x = 0, y = 0.15, "0.90", col = "#56B4E9", cex = 2)
text(x = -3, y = 0.05, "0.05", col = "#56B4E9", cex = 1.5)
text(x = 3, y = 0.05, "0.05", col = "gray", cex = 1.5)
```

---

## Interpretation of confidence intervals

.question[
`r emo::ji("bust_in_silhouette")` Which of the following is more informative: 

<ul>
<li> The difference in price of a gallon of milk between Whole Foods and Harris Teeter is 30 cents.
<li> A gallon of milk costs 30 cents more at Whole Foods compared to Harris Teeter.
</ul>
</div>
]

--

.question[
`r emo::ji("bust_in_silhouette")` What does your answer tell you about interpretation of confidence intervals for differences between two population parameters?
]

---

class: center, middle

# Hypothesis tests

---

## Hypothesis testing

- Set the hypotheses.

- Calculate the observed sample statistic.

- Calculate the p-value.

- Make a conclusion, about the hypotheses, in context of the data and the research question.

- `infer::hypothesize(null = "point")` and `infer::generate(reps, type = "simulate")` or `infer::generate(reps, type = "bootstrap")`

- `infer::hypothesize(null = "independence")` and `infer::generate(reps, type = "permute")`
  
---

## Hypothesis testing exercises

.small[
.question[
`r emo::ji("busts_in_silhouette")`
Describe the simulation process for tesing for the parameter assigned to your team.

- Note any assumptions you make in terms of sample size, observed sample statistic, etc.
- Imagine using index cards or chips to represent the data. 
- Specify whether the null hypothesis would be independence or point.
- Specify whether the simulation type would be bootstrap, simulate, or permute.

> **Panda Express, BME, get MECT, Duke Squirrels, Team Power:** single standard deviation

> **ACE, Kimchi Stew, Databaes, HJC, 23, 24/7, five squared:** single population mean

> **Team Untitled, R we done yet?, Blue Wombats, Cosmic:** difference between two population proportions

> **InterstellR, Tequila Mockingbird, Sweeter than SugR:** difference between two population medians

> **The Data Wranglers, Git R Done, Migos, Six Squared:** single population median
]]

---

## Testing errors

- Type 1: Reject $H_0$ when you shouldn't have
    + P(Type 1 error) = $\alpha$
    
- Type 2: Fail to reject $H_0$ when you should have
    + P(Type 2 error) is harder to calculate, but increases as $\alpha$ decreases

--

.question[
`r emo::ji("bust_in_silhouette")` In a court of law

- Null hypothesis: Defendant is innocent
- Alternative hypothesis: Defendant is guilty

Which is worse: Type 1 or Type 2 error?
]

---

## Probabilities of testing errors

- P(Type 1 error) = $\alpha$

- P(Type 2 error) = 1 - Power

- Power = P(correctly rejecting the null hypothesis)

--

.question[
`r emo::ji("busts_in_silhouette")` Fill in the blanks in terms of correctly/incorrectly rejecting/failing to reject the null hypothesis:

- $\alpha$ is the probability of ______.
- 1 - Power is the probability of ______.
]
